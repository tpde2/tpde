; NOTE: Assertions have been autogenerated by test/update_tpde_llc_test_checks.py UTC_ARGS: --tool tpde_test --version 5
; SPDX-FileCopyrightText: 2025 Contributors to TPDE <https://tpde.org>
; SPDX-License-Identifier: Apache-2.0 WITH LLVM-exception

; RUN: tpde_test --target=x86_64 %s --no-fixed-assignments | %objdump | FileCheck %s --check-prefixes=X64
; RUN: tpde_test --target=aarch64 %s --no-fixed-assignments | %objdump | FileCheck %s --check-prefixes=ARM64

define @tbz(%a, %b) {
; X64-LABEL: <tbz>:
; X64:         push rbp
; X64-NEXT:    mov rbp, rsp
; X64-NEXT:    bt rdi, 0x2f
; X64-NEXT:    mov qword ptr [rbp - 0x30], rdi
; X64-NEXT:    jae <L0>
; X64-NEXT:    mov rax, rdi
; X64-NEXT:    sub rax, rsi
; X64-NEXT:    jmp <L1>
; X64-NEXT:  <L0>:
; X64-NEXT:    mov rax, qword ptr [rbp - 0x30]
; X64-NEXT:    lea rcx, [rax + rax]
; X64-NEXT:  <L1>:
; X64-NEXT:    pop rbp
; X64-NEXT:    ret
;
; ARM64-LABEL: <tbz>:
; ARM64:         stp x29, x30, [sp, #-0xb0]!
; ARM64-NEXT:    mov x29, sp
; ARM64-NEXT:    str x0, [x29, #0xa0]
; ARM64-NEXT:    tbnz x0, #0x2f, 0x18 <tbz+0x18>
; ARM64-NEXT:    sub x2, x0, x1
; ARM64-NEXT:    b 0x20 <tbz+0x20>
; ARM64-NEXT:    ldr x0, [x29, #0xa0]
; ARM64-NEXT:    add x1, x0, x0
; ARM64-NEXT:    ldp x29, x30, [sp], #0xb0
; ARM64-NEXT:    ret
entry:
  tbz %a, ^tgt1, ^tgt2, 47
tgt1:
  %s1 = sub %a, %b
  br ^ret
tgt2:
  %s2 = add %a, %a
  br ^ret
ret:
  terminate
}

define @tbz_small(%a, %b) {
; X64-LABEL: <tbz_small>:
; X64:         push rbp
; X64-NEXT:    mov rbp, rsp
; X64-NEXT:    bt rdi, 0x2f
; X64-NEXT:    mov qword ptr [rbp - 0x30], rdi
; X64-NEXT:    jae <L0>
; X64-NEXT:    jmp <L1>
; X64-NEXT:     ...
; X64-NEXT:    mov rax, rdi
; X64-NEXT:    sub rax, rsi
; X64-NEXT:    jmp <L2>
; X64-NEXT:  <L0>:
; X64-NEXT:    mov rax, qword ptr [rbp - 0x30]
; X64-NEXT:    lea rcx, [rax + rax]
; X64-NEXT:  <L2>:
; X64-NEXT:    pop rbp
; X64-NEXT:    ret
;
; ARM64-LABEL: <tbz_small>:
; ARM64:         stp x29, x30, [sp, #-0xb0]!
; ARM64-NEXT:    mov x29, sp
; ARM64-NEXT:    str x0, [x29, #0xa0]
; ARM64-NEXT:    tbnz x0, #0x2f, 0x838 <tbz_small+0x808>
; ARM64-NEXT:    b 0x830 <tbz_small+0x800>
; ARM64-NEXT:     ...
; ARM64-NEXT:    sub x2, x0, x1
; ARM64-NEXT:    b 0x840 <tbz_small+0x810>
; ARM64-NEXT:    ldr x0, [x29, #0xa0]
; ARM64-NEXT:    add x1, x0, x0
; ARM64-NEXT:    ldp x29, x30, [sp], #0xb0
; ARM64-NEXT:    ret
entry:
  tbz %a, ^tgt1, ^tgt2, 47
tgt1:
  zerofill 0x7f0
  %s1 = sub %a, %b
  br ^ret
tgt2:
  %s2 = add %a, %a
  br ^ret
ret:
  terminate
}

; Medium-sized tbz; veener space is allocated but not used
define @tbz_medium(%a, %b) {
; X64-LABEL: <tbz_medium>:
; X64:         push rbp
; X64-NEXT:    mov rbp, rsp
; X64-NEXT:    bt rdi, 0x2f
; X64-NEXT:    mov qword ptr [rbp - 0x30], rdi
; X64-NEXT:    jae <L0>
; X64-NEXT:    jmp <L1>
; X64-NEXT:     ...
; X64-NEXT:    mov rax, rdi
; X64-NEXT:    sub rax, rsi
; X64-NEXT:    jmp <L2>
; X64-NEXT:  <L0>:
; X64-NEXT:    mov rax, qword ptr [rbp - 0x30]
; X64-NEXT:    lea rcx, [rax + rax]
; X64-NEXT:  <L2>:
; X64-NEXT:    pop rbp
; X64-NEXT:    ret
;
; ARM64-LABEL: <tbz_medium>:
; ARM64:         stp x29, x30, [sp, #-0xb0]!
; ARM64-NEXT:    mov x29, sp
; ARM64-NEXT:    str x0, [x29, #0xa0]
; ARM64-NEXT:    tbnz x0, #0x2f, 0x8850 <tbz_medium+0x8000>
; ARM64-NEXT:    b 0x4860 <tbz_medium+0x4010>
; ARM64-NEXT:     ...
; ARM64-NEXT:    b 0x4868 <tbz_medium+0x4018>
; ARM64-NEXT:    udf #0x0
; ARM64-NEXT:    b 0x8848 <tbz_medium+0x7ff8>
; ARM64-NEXT:     ...
; ARM64-NEXT:    sub x2, x0, x1
; ARM64-NEXT:    b 0x8858 <tbz_medium+0x8008>
; ARM64-NEXT:    ldr x0, [x29, #0xa0]
; ARM64-NEXT:    add x1, x0, x0
; ARM64-NEXT:    ldp x29, x30, [sp], #0xb0
; ARM64-NEXT:    ret
entry:
  tbz %a, ^tgt1, ^tgt2, 47
tgt1:
  zerofill 0x7fe0
  %s1 = sub %a, %b
  br ^ret
tgt2:
  %s2 = add %a, %a
  br ^ret
ret:
  terminate
}

; Large-sized tbz; veener must be used
define @tbz_large(%a, %b) {
; X64-LABEL: <tbz_large>:
; X64:         push rbp
; X64-NEXT:    mov rbp, rsp
; X64-NEXT:    bt rdi, 0x2f
; X64-NEXT:    mov qword ptr [rbp - 0x30], rdi
; X64-NEXT:    jae <L0>
; X64-NEXT:    jmp <L1>
; X64-NEXT:     ...
; X64-NEXT:    mov rax, rdi
; X64-NEXT:    sub rax, rsi
; X64-NEXT:    jmp <L2>
; X64-NEXT:  <L0>:
; X64-NEXT:    mov rax, qword ptr [rbp - 0x30]
; X64-NEXT:    lea rcx, [rax + rax]
; X64-NEXT:  <L2>:
; X64-NEXT:    pop rbp
; X64-NEXT:    ret
;
; ARM64-LABEL: <tbz_large>:
; ARM64:         stp x29, x30, [sp, #-0xb0]!
; ARM64-NEXT:    mov x29, sp
; ARM64-NEXT:    str x0, [x29, #0xa0]
; ARM64-NEXT:    tbnz x0, #0x2f, 0x8874 <tbz_large+0x14>
; ARM64-NEXT:    b 0x8878 <tbz_large+0x18>
; ARM64-NEXT:    b 0x10880 <tbz_large+0x8020>
; ARM64-NEXT:    b 0xc878 <tbz_large+0x4018>
; ARM64-NEXT:     ...
; ARM64-NEXT:    b 0x10878 <tbz_large+0x8018>
; ARM64-NEXT:     ...
; ARM64-NEXT:    sub x2, x0, x1
; ARM64-NEXT:    b 0x10888 <tbz_large+0x8028>
; ARM64-NEXT:    ldr x0, [x29, #0xa0]
; ARM64-NEXT:    add x1, x0, x0
; ARM64-NEXT:    ldp x29, x30, [sp], #0xb0
; ARM64-NEXT:    ret
entry:
  tbz %a, ^tgt1, ^tgt2, 47
tgt1:
  zerofill 0x8000
  %s1 = sub %a, %b
  br ^ret
tgt2:
  %s2 = add %a, %a
  br ^ret
ret:
  terminate
}
