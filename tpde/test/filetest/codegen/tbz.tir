; NOTE: Assertions have been autogenerated by test/update_tpde_llc_test_checks.py UTC_ARGS: --tool tpde_test --version 5
; SPDX-FileCopyrightText: 2025 Contributors to TPDE <https://tpde.org>
; SPDX-License-Identifier: Apache-2.0 WITH LLVM-exception

; RUN: tpde_test --target=x86_64 %s --no-fixed-assignments | %objdump | FileCheck %s --check-prefixes=X64
; RUN: tpde_test --target=aarch64 %s --no-fixed-assignments | %objdump | FileCheck %s --check-prefixes=ARM64

define @tbz(%a) {
; X64-LABEL: <tbz>:
; X64:         push rbp
; X64-NEXT:    mov rbp, rsp
; X64-NEXT:    nop word ptr [rax + rax]
; X64-NEXT:    nop dword ptr [rax]
; X64-NEXT:    bt rdi, 0x2f
; X64-NEXT:    mov qword ptr [rbp - 0x30], rdi
; X64-NEXT:    jae <L0>
; X64-NEXT:    mov rax, rdi
; X64-NEXT:    sub rax, rdi
; X64-NEXT:    jmp <L1>
; X64-NEXT:  <L0>:
; X64-NEXT:    mov rax, qword ptr [rbp - 0x30]
; X64-NEXT:    lea rcx, [rax + rax]
; X64-NEXT:  <L1>:
; X64-NEXT:    pop rbp
; X64-NEXT:    ret
;
; ARM64-LABEL: <tbz>:
; ARM64:         stp x29, x30, [sp, #-0xb0]!
; ARM64-NEXT:    mov x29, sp
; ARM64-NEXT:    nop
; ARM64-NEXT:    nop
; ARM64-NEXT:    str x0, [x29, #0xa0]
; ARM64-NEXT:    tbnz x0, #0x2f, 0x40 <tbz+0x20>
; ARM64-NEXT:    sub x1, x0, x0
; ARM64-NEXT:    b 0x48 <tbz+0x28>
; ARM64-NEXT:    ldr x0, [x29, #0xa0]
; ARM64-NEXT:    add x1, x0, x0
; ARM64-NEXT:    ldp x29, x30, [sp], #0xb0
; ARM64-NEXT:    ret
entry:
  tbz %a, ^tgt1, ^tgt2, 47
tgt1:
  %s1 = sub %a, %a
  br ^ret
tgt2:
  %s2 = add %a, %a
  br ^ret
ret:
  terminate
}

define @tbz_small(%a) {
; X64-LABEL: <tbz_small>:
; X64:         push rbp
; X64-NEXT:    mov rbp, rsp
; X64-NEXT:    nop word ptr [rax + rax]
; X64-NEXT:    nop dword ptr [rax]
; X64-NEXT:    bt rdi, 0x2f
; X64-NEXT:    mov qword ptr [rbp - 0x30], rdi
; X64-NEXT:    jae <L0>
; X64-NEXT:    jmp <L1>
; X64-NEXT:     ...
; X64-NEXT:    mov rax, rdi
; X64-NEXT:    sub rax, rdi
; X64-NEXT:    jmp <L2>
; X64-NEXT:  <L0>:
; X64-NEXT:    mov rax, qword ptr [rbp - 0x30]
; X64-NEXT:    lea rcx, [rax + rax]
; X64-NEXT:  <L2>:
; X64-NEXT:    pop rbp
; X64-NEXT:    ret
;
; ARM64-LABEL: <tbz_small>:
; ARM64:         stp x29, x30, [sp, #-0xb0]!
; ARM64-NEXT:    mov x29, sp
; ARM64-NEXT:    nop
; ARM64-NEXT:    nop
; ARM64-NEXT:    str x0, [x29, #0xa0]
; ARM64-NEXT:    tbnz x0, #0x2f, 0x880 <tbz_small+0x810>
; ARM64-NEXT:    b 0x878 <tbz_small+0x808>
; ARM64-NEXT:     ...
; ARM64-NEXT:    sub x1, x0, x0
; ARM64-NEXT:    b 0x888 <tbz_small+0x818>
; ARM64-NEXT:    ldr x0, [x29, #0xa0]
; ARM64-NEXT:    add x1, x0, x0
; ARM64-NEXT:    ldp x29, x30, [sp], #0xb0
; ARM64-NEXT:    ret
entry:
  tbz %a, ^tgt1, ^tgt2, 47
tgt1:
  zerofill 0x7f0
  %s1 = sub %a, %a
  br ^ret
tgt2:
  %s2 = add %a, %a
  br ^ret
ret:
  terminate
}

; Medium-sized tbz; veener space is allocated but not used
define @tbz_medium(%a) {
; X64-LABEL: <tbz_medium>:
; X64:         push rbp
; X64-NEXT:    mov rbp, rsp
; X64-NEXT:    nop word ptr [rax + rax]
; X64-NEXT:    nop dword ptr [rax]
; X64-NEXT:    bt rdi, 0x2f
; X64-NEXT:    mov qword ptr [rbp - 0x30], rdi
; X64-NEXT:    jae <L0>
; X64-NEXT:    jmp <L1>
; X64-NEXT:     ...
; X64-NEXT:    mov rax, rdi
; X64-NEXT:    sub rax, rdi
; X64-NEXT:    jmp <L2>
; X64-NEXT:  <L0>:
; X64-NEXT:    mov rax, qword ptr [rbp - 0x30]
; X64-NEXT:    lea rcx, [rax + rax]
; X64-NEXT:  <L2>:
; X64-NEXT:    pop rbp
; X64-NEXT:    ret
;
; ARM64-LABEL: <tbz_medium>:
; ARM64:         stp x29, x30, [sp, #-0xb0]!
; ARM64-NEXT:    mov x29, sp
; ARM64-NEXT:    nop
; ARM64-NEXT:    nop
; ARM64-NEXT:    str x0, [x29, #0xa0]
; ARM64-NEXT:    tbnz x0, #0x2f, 0x87d8 <tbz_medium+0x7f28>
; ARM64-NEXT:    b 0x8d0 <tbz_medium+0x20>
; ARM64-NEXT:    udf #0x0
; ARM64-NEXT:    b 0x87d0 <tbz_medium+0x7f20>
; ARM64-NEXT:     ...
; ARM64-NEXT:    sub x1, x0, x0
; ARM64-NEXT:    b 0x87e0 <tbz_medium+0x7f30>
; ARM64-NEXT:    ldr x0, [x29, #0xa0]
; ARM64-NEXT:    add x1, x0, x0
; ARM64-NEXT:    ldp x29, x30, [sp], #0xb0
; ARM64-NEXT:    ret
entry:
  tbz %a, ^tgt1, ^tgt2, 47
tgt1:
  zerofill 0x7f00
  %s1 = sub %a, %a
  br ^ret
tgt2:
  %s2 = add %a, %a
  br ^ret
ret:
  terminate
}

; Large-sized tbz; veener must be used
define @tbz_large(%a) {
; X64-LABEL: <tbz_large>:
; X64:         push rbp
; X64-NEXT:    mov rbp, rsp
; X64-NEXT:    nop word ptr [rax + rax]
; X64-NEXT:    nop dword ptr [rax]
; X64-NEXT:    bt rdi, 0x2f
; X64-NEXT:    mov qword ptr [rbp - 0x30], rdi
; X64-NEXT:    jae <L0>
; X64-NEXT:    jmp <L1>
; X64-NEXT:     ...
; X64-NEXT:    mov rax, rdi
; X64-NEXT:    sub rax, rdi
; X64-NEXT:    jmp <L2>
; X64-NEXT:  <L0>:
; X64-NEXT:    mov rax, qword ptr [rbp - 0x30]
; X64-NEXT:    lea rcx, [rax + rax]
; X64-NEXT:  <L2>:
; X64-NEXT:    pop rbp
; X64-NEXT:    ret
;
; ARM64-LABEL: <tbz_large>:
; ARM64:         stp x29, x30, [sp, #-0xb0]!
; ARM64-NEXT:    mov x29, sp
; ARM64-NEXT:    nop
; ARM64-NEXT:    nop
; ARM64-NEXT:    str x0, [x29, #0xa0]
; ARM64-NEXT:    tbnz x0, #0x2f, 0x882c <tbz_large+0x1c>
; ARM64-NEXT:    b 0x8830 <tbz_large+0x20>
; ARM64-NEXT:    b 0x10838 <tbz_large+0x8028>
; ARM64-NEXT:    b 0x10830 <tbz_large+0x8020>
; ARM64-NEXT:     ...
; ARM64-NEXT:    sub x1, x0, x0
; ARM64-NEXT:    b 0x10840 <tbz_large+0x8030>
; ARM64-NEXT:    ldr x0, [x29, #0xa0]
; ARM64-NEXT:    add x1, x0, x0
; ARM64-NEXT:    ldp x29, x30, [sp], #0xb0
; ARM64-NEXT:    ret
entry:
  tbz %a, ^tgt1, ^tgt2, 47
tgt1:
  zerofill 0x8000
  %s1 = sub %a, %a
  br ^ret
tgt2:
  %s2 = add %a, %a
  br ^ret
ret:
  terminate
}
