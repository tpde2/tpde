; NOTE: Assertions have been autogenerated by test/update_tpde_llc_test_checks.py UTC_ARGS: --tool tpde_test --version 5
; SPDX-FileCopyrightText: 2025 Contributors to TPDE <https://tpde.org>
; SPDX-License-Identifier: Apache-2.0 WITH LLVM-exception

; RUN: tpde_test --target=x86_64 %s --no-fixed-assignments | %objdump | FileCheck %s --check-prefixes=X64
; RUN: tpde_test --target=x86_64 %s | %objdump | FileCheck %s --check-prefixes=X64-FIXED
; RUN: tpde_test --target=aarch64 %s --no-fixed-assignments | %objdump | FileCheck %s --check-prefixes=ARM64
; RUN: tpde_test --target=aarch64 %s | %objdump | FileCheck %s --check-prefixes=ARM64-FIXED

define @br1() {
; X64-LABEL: <br1>:
; X64:         ret
;
; X64-FIXED-LABEL: <br1>:
; X64-FIXED:         ret
;
; ARM64-LABEL: <br1>:
; ARM64:         ret
;
; ARM64-FIXED-LABEL: <br1>:
; ARM64-FIXED:         ret
entry:
  br ^ret
ret:
  terminate
}

define @condbr1(%a, %b) {
; X64-LABEL: <condbr1>:
; X64:         push rbp
; X64-NEXT:    mov rbp, rsp
; X64-NEXT:    test rdi, rdi
; X64-NEXT:    mov qword ptr [rbp - 0x30], rsi
; X64-NEXT:    je <L0>
; X64-NEXT:    mov rax, rdi
; X64-NEXT:    jmp <L1>
; X64-NEXT:  <L0>:
; X64-NEXT:    mov rax, qword ptr [rbp - 0x30]
; X64-NEXT:  <L1>:
; X64-NEXT:    pop rbp
; X64-NEXT:    ret
;
; X64-FIXED-LABEL: <condbr1>:
; X64-FIXED:         mov r10, rdi
; X64-FIXED-NEXT:    mov rdi, rsi
; X64-FIXED-NEXT:    test r10, r10
; X64-FIXED-NEXT:    je <L0>
; X64-FIXED-NEXT:    mov rax, r10
; X64-FIXED-NEXT:    jmp <L1>
; X64-FIXED-NEXT:  <L0>:
; X64-FIXED-NEXT:    mov rax, rdi
; X64-FIXED-NEXT:  <L1>:
; X64-FIXED-NEXT:    ret
;
; ARM64-LABEL: <condbr1>:
; ARM64:         stp x29, x30, [sp, #-0xb0]!
; ARM64-NEXT:    mov x29, sp
; ARM64-NEXT:    cmp x0, #0x0
; ARM64-NEXT:    str x1, [x29, #0xa0]
; ARM64-NEXT:    b.eq 0x28 <condbr1+0x18>
; ARM64-NEXT:    b 0x2c <condbr1+0x1c>
; ARM64-NEXT:    ldr x0, [x29, #0xa0]
; ARM64-NEXT:    ldp x29, x30, [sp], #0xb0
; ARM64-NEXT:    ret
;
; ARM64-FIXED-LABEL: <condbr1>:
; ARM64-FIXED:         mov x9, x0
; ARM64-FIXED-NEXT:    mov x10, x1
; ARM64-FIXED-NEXT:    cmp x9, #0x0
; ARM64-FIXED-NEXT:    b.eq 0x28 <condbr1+0x18>
; ARM64-FIXED-NEXT:    mov x0, x9
; ARM64-FIXED-NEXT:    b 0x2c <condbr1+0x1c>
; ARM64-FIXED-NEXT:    mov x0, x10
; ARM64-FIXED-NEXT:    ret
entry:
  condbr %a, ^ret1, ^ret2
ret1:
  ret %a
ret2:
  ret %b
}

define @condbr2(%a, %b) {
; X64-LABEL: <condbr2>:
; X64:         push rbp
; X64-NEXT:    mov rbp, rsp
; X64-NEXT:    test rdi, rdi
; X64-NEXT:    mov qword ptr [rbp - 0x30], rdi
; X64-NEXT:    jne <L0>
; X64-NEXT:    mov rax, rsi
; X64-NEXT:    jmp <L1>
; X64-NEXT:  <L0>:
; X64-NEXT:    mov rax, qword ptr [rbp - 0x30]
; X64-NEXT:  <L1>:
; X64-NEXT:    pop rbp
; X64-NEXT:    ret
;
; X64-FIXED-LABEL: <condbr2>:
; X64-FIXED:         mov r10, rdi
; X64-FIXED-NEXT:    mov rdi, rsi
; X64-FIXED-NEXT:    test r10, r10
; X64-FIXED-NEXT:    jne <L0>
; X64-FIXED-NEXT:    mov rax, rdi
; X64-FIXED-NEXT:    jmp <L1>
; X64-FIXED-NEXT:  <L0>:
; X64-FIXED-NEXT:    mov rax, r10
; X64-FIXED-NEXT:  <L1>:
; X64-FIXED-NEXT:    ret
;
; ARM64-LABEL: <condbr2>:
; ARM64:         stp x29, x30, [sp, #-0xb0]!
; ARM64-NEXT:    mov x29, sp
; ARM64-NEXT:    cmp x0, #0x0
; ARM64-NEXT:    str x0, [x29, #0xa0]
; ARM64-NEXT:    b.ne 0x5c <condbr2+0x1c>
; ARM64-NEXT:    mov x0, x1
; ARM64-NEXT:    b 0x60 <condbr2+0x20>
; ARM64-NEXT:    ldr x0, [x29, #0xa0]
; ARM64-NEXT:    ldp x29, x30, [sp], #0xb0
; ARM64-NEXT:    ret
;
; ARM64-FIXED-LABEL: <condbr2>:
; ARM64-FIXED:         mov x9, x0
; ARM64-FIXED-NEXT:    mov x10, x1
; ARM64-FIXED-NEXT:    cmp x9, #0x0
; ARM64-FIXED-NEXT:    b.ne 0x48 <condbr2+0x18>
; ARM64-FIXED-NEXT:    mov x0, x10
; ARM64-FIXED-NEXT:    b 0x4c <condbr2+0x1c>
; ARM64-FIXED-NEXT:    mov x0, x9
; ARM64-FIXED-NEXT:    ret
entry:
  condbr %a, ^ret1, ^ret2
ret2:
  ret %b
ret1:
  ret %a
}

define @condbr3(%a, %b, %c) {
; X64-LABEL: <condbr3>:
; X64:         push rbp
; X64-NEXT:    mov rbp, rsp
; X64-NEXT:    test rdi, rdi
; X64-NEXT:    mov qword ptr [rbp - 0x30], rdx
; X64-NEXT:    jne <L0>
; X64-NEXT:    mov qword ptr [rbp - 0x38], rsi
; X64-NEXT:    jmp <L1>
; X64-NEXT:  <L0>:
; X64-NEXT:    add rsi, rdx
; X64-NEXT:    mov qword ptr [rbp - 0x38], rsi
; X64-NEXT:  <L1>:
; X64-NEXT:    mov rax, qword ptr [rbp - 0x30]
; X64-NEXT:    mov rcx, qword ptr [rbp - 0x38]
; X64-NEXT:    sub rax, rcx
; X64-NEXT:    pop rbp
; X64-NEXT:    ret
;
; X64-FIXED-LABEL: <condbr3>:
; X64-FIXED:         mov r10, rsi
; X64-FIXED-NEXT:    mov rsi, rdx
; X64-FIXED-NEXT:    test rdi, rdi
; X64-FIXED-NEXT:    jne <L0>
; X64-FIXED-NEXT:    mov r8, r10
; X64-FIXED-NEXT:    jmp <L1>
; X64-FIXED-NEXT:  <L0>:
; X64-FIXED-NEXT:    add r10, rsi
; X64-FIXED-NEXT:    mov r8, r10
; X64-FIXED-NEXT:  <L1>:
; X64-FIXED-NEXT:    sub rsi, r8
; X64-FIXED-NEXT:    mov rax, rsi
; X64-FIXED-NEXT:    ret
;
; ARM64-LABEL: <condbr3>:
; ARM64:         stp x29, x30, [sp, #-0xb0]!
; ARM64-NEXT:    mov x29, sp
; ARM64-NEXT:    cmp x0, #0x0
; ARM64-NEXT:    str x2, [x29, #0xa0]
; ARM64-NEXT:    b.ne 0x8c <condbr3+0x1c>
; ARM64-NEXT:    str x1, [x29, #0xa8]
; ARM64-NEXT:    b 0x94 <condbr3+0x24>
; ARM64-NEXT:    add x1, x1, x2
; ARM64-NEXT:    str x1, [x29, #0xa8]
; ARM64-NEXT:    ldr x0, [x29, #0xa0]
; ARM64-NEXT:    ldr x1, [x29, #0xa8]
; ARM64-NEXT:    sub x0, x0, x1
; ARM64-NEXT:    ldp x29, x30, [sp], #0xb0
; ARM64-NEXT:    ret
;
; ARM64-FIXED-LABEL: <condbr3>:
; ARM64-FIXED:         mov x9, x1
; ARM64-FIXED-NEXT:    mov x10, x2
; ARM64-FIXED-NEXT:    cmp x0, #0x0
; ARM64-FIXED-NEXT:    b.ne 0x68 <condbr3+0x18>
; ARM64-FIXED-NEXT:    mov x2, x9
; ARM64-FIXED-NEXT:    b 0x70 <condbr3+0x20>
; ARM64-FIXED-NEXT:    add x9, x9, x10
; ARM64-FIXED-NEXT:    mov x2, x9
; ARM64-FIXED-NEXT:    sub x10, x10, x2
; ARM64-FIXED-NEXT:    mov x0, x10
; ARM64-FIXED-NEXT:    ret
entry:
  condbr %a, ^t, ^f
t:
  %d = add %b, %c
  br ^f
f:
  %e = phi [^entry, %b], [^t, %d]
  %f = sub %c, %e
  ret %f
}


define @loop1(%a, %b) {
; X64-LABEL: <loop1>:
; X64:         push rbp
; X64-NEXT:    mov rbp, rsp
; X64-NEXT:    mov qword ptr [rbp - 0x30], rsi
; X64-NEXT:    mov qword ptr [rbp - 0x38], rdi
; X64-NEXT:  <L1>:
; X64-NEXT:    mov rax, qword ptr [rbp - 0x38]
; X64-NEXT:    test rax, rax
; X64-NEXT:    je <L0>
; X64-NEXT:    mov rcx, rax
; X64-NEXT:    mov rdx, qword ptr [rbp - 0x30]
; X64-NEXT:    sub rcx, rdx
; X64-NEXT:    mov qword ptr [rbp - 0x38], rcx
; X64-NEXT:    jmp <L1>
; X64-NEXT:  <L0>:
; X64-NEXT:    pop rbp
; X64-NEXT:    ret
;
; X64-FIXED-LABEL: <loop1>:
; X64-FIXED:         mov r10, rsi
; X64-FIXED-NEXT:    mov rsi, rdi
; X64-FIXED-NEXT:  <L1>:
; X64-FIXED-NEXT:    test rsi, rsi
; X64-FIXED-NEXT:    je <L0>
; X64-FIXED-NEXT:    mov rax, rsi
; X64-FIXED-NEXT:    sub rax, r10
; X64-FIXED-NEXT:    mov rsi, rax
; X64-FIXED-NEXT:    jmp <L1>
; X64-FIXED-NEXT:  <L0>:
; X64-FIXED-NEXT:    ret
;
; ARM64-LABEL: <loop1>:
; ARM64:         stp x29, x30, [sp, #-0xb0]!
; ARM64-NEXT:    mov x29, sp
; ARM64-NEXT:    str x1, [x29, #0xa0]
; ARM64-NEXT:    str x0, [x29, #0xa8]
; ARM64-NEXT:    ldr x0, [x29, #0xa8]
; ARM64-NEXT:    cmp x0, #0x0
; ARM64-NEXT:    b.eq 0xdc <loop1+0x2c>
; ARM64-NEXT:    ldr x1, [x29, #0xa0]
; ARM64-NEXT:    sub x2, x0, x1
; ARM64-NEXT:    str x2, [x29, #0xa8]
; ARM64-NEXT:    b 0xc0 <loop1+0x10>
; ARM64-NEXT:    ldp x29, x30, [sp], #0xb0
; ARM64-NEXT:    ret
;
; ARM64-FIXED-LABEL: <loop1>:
; ARM64-FIXED:         mov x9, x1
; ARM64-FIXED-NEXT:    mov x2, x0
; ARM64-FIXED-NEXT:    cmp x2, #0x0
; ARM64-FIXED-NEXT:    b.eq 0x9c <loop1+0x1c>
; ARM64-FIXED-NEXT:    sub x0, x2, x9
; ARM64-FIXED-NEXT:    mov x2, x0
; ARM64-FIXED-NEXT:    b 0x88 <loop1+0x8>
; ARM64-FIXED-NEXT:    ret
entry:
  br ^loop_head
loop_head:
  %p = phi [^entry, %a], [^loop_body, %c]
; TODO: make cmp use the memory operand if possible?
  condbr %p, ^loop_body, ^ret
loop_body:
  %c = sub %p, %b
  br ^loop_head
ret:
  terminate
}

define @phi_chain1(%a) {
; X64-LABEL: <phi_chain1>:
; X64:         push rbp
; X64-NEXT:    mov rbp, rsp
; X64-NEXT:    mov qword ptr [rbp - 0x30], rdi
; X64-NEXT:    mov qword ptr [rbp - 0x38], rdi
; X64-NEXT:  <L1>:
; X64-NEXT:    mov rax, qword ptr [rbp - 0x38]
; X64-NEXT:    test rax, rax
; X64-NEXT:    je <L0>
; X64-NEXT:    mov rcx, qword ptr [rbp - 0x30]
; X64-NEXT:    lea rdx, [rcx + rax]
; X64-NEXT:    mov qword ptr [rbp - 0x38], rcx
; X64-NEXT:    mov qword ptr [rbp - 0x30], rdx
; X64-NEXT:    jmp <L1>
; X64-NEXT:  <L0>:
; X64-NEXT:    pop rbp
; X64-NEXT:    ret
;
; X64-FIXED-LABEL: <phi_chain1>:
; X64-FIXED:         mov rsi, rdi
; X64-FIXED-NEXT:    mov r8, rdi
; X64-FIXED-NEXT:  <L1>:
; X64-FIXED-NEXT:    test r8, r8
; X64-FIXED-NEXT:    je <L0>
; X64-FIXED-NEXT:    lea rax, [rsi + r8]
; X64-FIXED-NEXT:    mov r8, rsi
; X64-FIXED-NEXT:    mov rsi, rax
; X64-FIXED-NEXT:    jmp <L1>
; X64-FIXED-NEXT:  <L0>:
; X64-FIXED-NEXT:    ret
;
; ARM64-LABEL: <phi_chain1>:
; ARM64:         stp x29, x30, [sp, #-0xb0]!
; ARM64-NEXT:    mov x29, sp
; ARM64-NEXT:    str x0, [x29, #0xa0]
; ARM64-NEXT:    str x0, [x29, #0xa8]
; ARM64-NEXT:    ldr x0, [x29, #0xa8]
; ARM64-NEXT:    cmp x0, #0x0
; ARM64-NEXT:    b.eq 0x120 <phi_chain1+0x30>
; ARM64-NEXT:    ldr x1, [x29, #0xa0]
; ARM64-NEXT:    add x2, x1, x0
; ARM64-NEXT:    str x1, [x29, #0xa8]
; ARM64-NEXT:    str x2, [x29, #0xa0]
; ARM64-NEXT:    b 0x100 <phi_chain1+0x10>
; ARM64-NEXT:    ldp x29, x30, [sp], #0xb0
; ARM64-NEXT:    ret
;
; ARM64-FIXED-LABEL: <phi_chain1>:
; ARM64-FIXED:         mov x2, x0
; ARM64-FIXED-NEXT:    mov x3, x0
; ARM64-FIXED-NEXT:    cmp x3, #0x0
; ARM64-FIXED-NEXT:    b.eq 0xc0 <phi_chain1+0x20>
; ARM64-FIXED-NEXT:    add x0, x2, x3
; ARM64-FIXED-NEXT:    mov x3, x2
; ARM64-FIXED-NEXT:    mov x2, x0
; ARM64-FIXED-NEXT:    b 0xa8 <phi_chain1+0x8>
; ARM64-FIXED-NEXT:    ret
entry:
  br ^loop_head
loop_head:
  %p1 = phi [^entry, %a], [^loop_body, %c]
  %p2 = phi [^entry, %a], [^loop_body, %p1]
  condbr %p2, ^loop_body, ^ret
loop_body:
  %c = add %p1, %p2
  br ^loop_head
ret:
  terminate
}

define @phi_cycle1(%a) {
; X64-LABEL: <phi_cycle1>:
; X64:         push rbp
; X64-NEXT:    mov rbp, rsp
; X64-NEXT:    mov qword ptr [rbp - 0x30], rdi
; X64-NEXT:    mov qword ptr [rbp - 0x38], rdi
; X64-NEXT:  <L1>:
; X64-NEXT:    mov rax, qword ptr [rbp - 0x38]
; X64-NEXT:    test rax, rax
; X64-NEXT:    je <L0>
; X64-NEXT:    mov rcx, qword ptr [rbp - 0x30]
; X64-NEXT:    lea rdx, [rcx + rax]
; X64-NEXT:    mov rdx, rcx
; X64-NEXT:    mov qword ptr [rbp - 0x30], rax
; X64-NEXT:    mov qword ptr [rbp - 0x38], rdx
; X64-NEXT:    jmp <L1>
; X64-NEXT:  <L0>:
; X64-NEXT:    pop rbp
; X64-NEXT:    ret
;
; X64-FIXED-LABEL: <phi_cycle1>:
; X64-FIXED:         mov rsi, rdi
; X64-FIXED-NEXT:    mov r8, rdi
; X64-FIXED-NEXT:  <L1>:
; X64-FIXED-NEXT:    test r8, r8
; X64-FIXED-NEXT:    je <L0>
; X64-FIXED-NEXT:    lea rax, [rsi + r8]
; X64-FIXED-NEXT:    mov rax, rsi
; X64-FIXED-NEXT:    mov rsi, r8
; X64-FIXED-NEXT:    mov r8, rax
; X64-FIXED-NEXT:    jmp <L1>
; X64-FIXED-NEXT:  <L0>:
; X64-FIXED-NEXT:    ret
;
; ARM64-LABEL: <phi_cycle1>:
; ARM64:         stp x29, x30, [sp, #-0xb0]!
; ARM64-NEXT:    mov x29, sp
; ARM64-NEXT:    str x0, [x29, #0xa0]
; ARM64-NEXT:    str x0, [x29, #0xa8]
; ARM64-NEXT:    ldr x0, [x29, #0xa8]
; ARM64-NEXT:    cmp x0, #0x0
; ARM64-NEXT:    b.eq 0x164 <phi_cycle1+0x34>
; ARM64-NEXT:    ldr x1, [x29, #0xa0]
; ARM64-NEXT:    add x2, x1, x0
; ARM64-NEXT:    mov x2, x1
; ARM64-NEXT:    str x0, [x29, #0xa0]
; ARM64-NEXT:    str x2, [x29, #0xa8]
; ARM64-NEXT:    b 0x140 <phi_cycle1+0x10>
; ARM64-NEXT:    ldp x29, x30, [sp], #0xb0
; ARM64-NEXT:    ret
;
; ARM64-FIXED-LABEL: <phi_cycle1>:
; ARM64-FIXED:         mov x2, x0
; ARM64-FIXED-NEXT:    mov x3, x0
; ARM64-FIXED-NEXT:    cmp x3, #0x0
; ARM64-FIXED-NEXT:    b.eq 0xf4 <phi_cycle1+0x24>
; ARM64-FIXED-NEXT:    add x0, x2, x3
; ARM64-FIXED-NEXT:    mov x0, x2
; ARM64-FIXED-NEXT:    mov x2, x3
; ARM64-FIXED-NEXT:    mov x3, x0
; ARM64-FIXED-NEXT:    b 0xd8 <phi_cycle1+0x8>
; ARM64-FIXED-NEXT:    ret
entry:
  br ^loop_head
loop_head:
  %p1 = phi [^entry, %a], [^loop_body, %p2]
  %p2 = phi [^entry, %a], [^loop_body, %p1]
  condbr %p2, ^loop_body, ^ret
loop_body:
  %c = add %p1, %p2
  br ^loop_head
ret:
  terminate
}
